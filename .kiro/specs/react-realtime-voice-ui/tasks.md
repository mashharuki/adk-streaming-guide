# Implementation Plan

- [x] 1. Reactベースの実行基盤と共通状態管理を整備する
- [x] 1.1 Vite + React + TypeScript + Tailwind + shadcn/ui構成でアプリ土台を確立する
  - 既存静的配信契約を維持できるビルド出力構成を整え、画面シェルを起動可能にする。
  - 会話・接続・通知・イベントログの共通状態ストアを初期化し、各機能が同じ状態源を参照できるようにする。
  - _Requirements: 1.5, 2.5, 8.5_
- [x] 1.2 レスポンシブAppShellと主要操作導線を実装する
  - Desktop/Tablet/Mobileでレイアウトを切り替え、会話領域・補助領域・操作導線を維持する。
  - レイアウト切替中も送信・音声開始・画像送信の到達可能性を保つ。
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_

- [x] 2. セッション接続制御と再接続オーケストレーションを実装する
- [x] 2.1 WebSocketセッション接続の状態遷移を実装する
  - 接続開始・成功・切断・再接続中・エラーの状態機械を定義し、UI表示へ一貫反映する。
  - 接続エラー時に利用者が識別可能な状態表示を維持する。
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5_
- [x] 2.2 再接続ポリシーと継続利用フローを実装する
  - 切断後の再接続試行、再接続中表示、復帰時の状態同期を統合する。
  - ライフサイクル通知と復旧中通知を通知センターへ連携する。
  - _Requirements: 2.2, 2.3, 8.1, 8.4_

- [x] 3. テキスト会話フローを実装する
- [x] 3.1 (P) テキスト送信入力とユーザー発話反映を実装する
  - 有効な入力のみ送信し、送信済みテキストを会話履歴に即時反映する。
  - 新着メッセージ時の追従表示を会話ビューに適用する。
  - _Requirements: 3.1, 3.5_
- [x] 3.2 エージェント応答の部分表示と完了確定を実装する
  - ストリーミング応答を部分表示として更新し、turn完了で確定表示へ遷移する。
  - interrupted発生時に該当ターンの表示状態を中断済みに更新する。
  - _Requirements: 3.2, 3.3, 3.4, 8.3_

- [x] 4. 音声入出力フローを実装する
- [x] 4.1 (P) 音声入力開始・停止と入力中表示を実装する
  - 音声開始操作で入力有効状態を表示し、停止で入力状態を解除する。
  - 入力有効中の音声チャンクを上流送信対象として扱う。
  - _Requirements: 4.1, 4.2_
- [x] 4.2 音声出力再生と中断制御を実装する
  - 下流音声イベントを再生処理へ接続し、再生状態をUIへ反映する。
  - interrupted受信時に進行中の音声出力を停止し中断状態を表示する。
  - _Requirements: 4.3, 4.4, 4.5_

- [x] 5. 画像入力とカメラモーダル体験を実装する
- [x] 5.1 (P) カメラプレビューの起動・終了と権限失敗通知を実装する
  - カメラ操作開始でプレビューモーダルを表示し、終了時に利用状態を解除する。
  - 権限拒否や取得失敗時に識別可能な失敗通知を表示する。
  - _Requirements: 5.1, 5.4, 5.5_
- [x] 5.2 (P) 撮影確定と画像送信フローを実装する
  - プレビュー中に送信/キャンセルの両導線を提供する。
  - 送信確定時に撮影画像を会話履歴へ反映し、送信要求として処理する。
  - _Requirements: 5.2, 5.3_

- [x] 6. Event Consoleと運用可観測性を実装する
- [x] 6.1 (P) 上下流イベントログの記録と詳細展開表示を実装する
  - イベントを時刻付きで記録し、詳細データを展開可能に表示する。
  - 通知イベントと通常会話イベントを視覚的に区別して表示する。
  - _Requirements: 6.1, 6.2, 8.5_
- [x] 6.2 (P) 音声イベント表示切替とログ初期化操作を実装する
  - 音声イベント表示の有効/無効切替を提供し、設定に応じてログ表示を制御する。
  - ログ消去操作で表示状態を即時初期化する。
  - _Requirements: 6.3, 6.4, 6.5_

- [x] 7. RunConfig契約に基づく設定反映フローを実装する
- [x] 7.1 RunConfigオプションUIと変更要求送信を実装する
  - Proactivity/Affective Dialogの切替UIを提供し、変更時にRunConfig契約形式で再接続要求を送る。
  - 反映中ステータスを表示し、反映完了まで操作状態を整合させる。
  - _Requirements: 7.1, 7.2, 7.3_
- [x] 7.2 RunConfig適用結果の反映・失敗通知・フォールバックを実装する
  - 適用結果イベントに基づき有効設定値を表示し、実値との乖離を明示する。
  - 非対応/失敗時は安全既定値または直前成功値へフォールバックし、会話継続性を維持する。
  - _Requirements: 7.4, 7.5, 7.6_

- [x] 8. システム通知とエラー回復体験を統合する
- [x] 8.1 接続・再接続・切断・エラーの通知連携を実装する
  - ライフサイクルイベントをシステムメッセージとして通知表示へ反映する。
  - WebSocketエラーを利用者通知と運用ログへ同時反映する。
  - _Requirements: 8.1, 8.2, 8.4_
- [x] 8.2 通知表示と会話表示の視覚分離を全画面サイズで統一する
  - システム通知と通常会話を一貫した視覚ルールで分離する。
  - レスポンシブ切替時にも通知の視認性と意味整合を維持する。
  - _Requirements: 1.5, 8.5_

- [x] 9. 統合検証と受け入れ基準トレースを実施する
- [x] 9.1 全主要フローの結合確認を実施する
  - 接続、テキスト、音声、画像、RunConfig、通知、イベントログを通しで確認する。
  - 主要エラー・中断シナリオを含む回復挙動を検証する。
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 3.4, 4.4, 5.4, 7.5, 8.2, 8.4_
- [x]* 9.2 受け入れ基準対応の自動テストを追加する
  - 状態遷移、部分応答確定、RunConfig反映結果、通知表示分離を自動検証対象にする。
  - モバイル/デスクトップ両レイアウトで主要操作導線と可視性の回帰を検証する。
  - _Requirements: 1.1, 1.3, 1.4, 3.3, 3.5, 7.4, 8.5_
