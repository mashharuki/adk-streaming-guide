name: ADK Version Monitor

on:
  schedule:
    # Run every 12 hours (midnight and noon UTC)
    - cron: '0 0,12 * * *'
  workflow_dispatch:  # Allow manual triggers
    inputs:
      force_check:
        description: 'Force check even if version unchanged'
        required: false
        default: 'false'

jobs:
  check-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # For committing version file
      issues: write    # For creating issues

    outputs:
      new_version_available: ${{ steps.check_version.outputs.new_version_available }}
      latest_version: ${{ steps.check_version.outputs.latest_version }}
      previous_version: ${{ steps.check_version.outputs.current_version }}
      parent_issue_number: ${{ steps.create_parent_issue.outputs.issue_number }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check latest ADK version on PyPI
        id: check_version
        run: |
          # Fetch latest version from PyPI
          LATEST_VERSION=$(curl -s https://pypi.org/pypi/google-adk/json | python3 -c "import sys, json; print(json.load(sys.stdin)['info']['version'])")
          echo "Latest PyPI version: $LATEST_VERSION"
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT

          # Read current tracked version
          if [ -f .github/current_adk_version.txt ]; then
            CURRENT_VERSION=$(cat .github/current_adk_version.txt)
          else
            CURRENT_VERSION="0.0.0"
          fi
          echo "Current tracked version: $CURRENT_VERSION"
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

          # Compare versions
          if [ "$LATEST_VERSION" != "$CURRENT_VERSION" ] || [ "${{ github.event.inputs.force_check }}" == "true" ]; then
            echo "new_version_available=true" >> $GITHUB_OUTPUT
            echo "New version detected or forced: $LATEST_VERSION"
          else
            echo "new_version_available=false" >> $GITHUB_OUTPUT
            echo "No new version available"
          fi

      - name: Create consolidated review issue
        if: steps.check_version.outputs.new_version_available == 'true'
        id: create_parent_issue
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.check_version.outputs.latest_version }}';
            const currentVersion = '${{ steps.check_version.outputs.current_version }}';
            const timestamp = new Date().toISOString();

            const body = `## ADK Version Update: ${currentVersion} â†’ ${version}

            A new version of the Google Agent Development Kit has been released.

            ### Version Information
            - **Previous Version**: ${currentVersion}
            - **New Version**: ${version}
            - **Detection Date**: ${timestamp}
            - **PyPI Package**: [google-adk==${version}](https://pypi.org/project/google-adk/${version}/)
            - **Compare Changes**: [v${currentVersion}...v${version}](https://github.com/google/adk-python/compare/v${currentVersion}...v${version})

            ### Review Instructions

            @claude Please use the **change-reviewer** agent to perform a consolidated review:

            1. **Analyze ADK changes** between v${currentVersion} and v${version}:
               - Run \`git fetch --tags && git log v${currentVersion}..v${version} --oneline\` in ../adk-python
               - Read CHANGELOG.md entries for v${version}
               - Focus on changes to: runners.py, live_request_queue.py, run_config.py, agents/

            2. **Review all documentation** for impacts:
               - docs/part1.md through docs/part5.md
               - Focus ONLY on sections affected by the version changes
               - Check cross-part consistency (a feature documented in one part counts as covered)

            3. **Review demo application** (src/bidi-demo/) for compatibility

            4. **Post findings** as a comment with:
               - Changes requiring documentation updates
               - Changes requiring demo code updates
               - Cross-references showing which parts already cover each change

            ---
            *This issue was automatically created by the ADK Version Monitor workflow.*
            `;

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ADK v${version} - Documentation Compatibility Review`,
              body: body,
              labels: ['adk-version-update', 'documentation', 'automated']
            });

            console.log(`Created review issue #${issue.data.number}`);
            core.setOutput('issue_number', issue.data.number);
            return issue.data.number;

      - name: Update version tracking file
        if: steps.check_version.outputs.new_version_available == 'true'
        run: |
          mkdir -p .github
          echo "${{ steps.check_version.outputs.latest_version }}" > .github/current_adk_version.txt

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/current_adk_version.txt

          # Only commit and push if there are changes
          if ! git diff --quiet --staged; then
            git commit -m "chore: update tracked ADK version to ${{ steps.check_version.outputs.latest_version }}"
            git push
          else
            echo "No changes to commit (version file already up to date)"
          fi

      - name: Summary
        if: always()
        run: |
          echo "## ADK Version Monitor Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Latest PyPI Version**: ${{ steps.check_version.outputs.latest_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Previous Tracked Version**: ${{ steps.check_version.outputs.current_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**New Version Available**: ${{ steps.check_version.outputs.new_version_available }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_version.outputs.new_version_available }}" == "true" ]; then
            echo "**Parent Issue Created**: #${{ steps.create_parent_issue.outputs.issue_number }}" >> $GITHUB_STEP_SUMMARY
          fi

